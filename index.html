<!DOCTYPE html>
<html lang="fr">

<head>
    <link rel="icon" href="favicon.png" type="image/png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAN Demain</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="marquee-bg">
        <div class="marquee-track" id="waiting-marquee-1"></div>
        <div class="marquee-track" id="waiting-marquee-2" style="animation-delay: -10s; animation-direction: reverse;">
        </div>
        <div class="marquee-track" id="waiting-marquee-3" style="animation-delay: -25s;"></div>
        <div class="marquee-track" id="waiting-marquee-4" style="animation-delay: -5s; animation-direction: reverse;">
        </div>
    </div>

    <div id="auth-container" class="luxury-panel">
        <h1>LAN Demain</h1>
        <p>Connecte-toi pour organiser la meilleure LAN !</p>
        <button id="google-login-btn">
            <svg id="google-icon" viewBox="0 0 24 24" fill="white">
                <path
                    d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                    fill="#4285F4" />
                <path
                    d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
                    fill="#34A853" />
                <path
                    d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
                    fill="#FBBC05" />
                <path
                    d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
                    fill="#EA4335" />
            </svg>
            <span id="login-btn-text">Se connecter à Google</span>
            <div id="login-spinner"></div>
        </button>
        <p id="auth-error" style="color: var(--danger-color); margin-top: 15px;"></p>
    </div>

    <div id="app-container" style="display: none;">
        <header id="global-header" class="container" style="position: relative; z-index: 10; padding-top: 40px;">
            <h1 id="main-title">LAN Demain</h1>
            <div id="user-info">
                <span id="user-name"></span>
                <img id="user-avatar" src="" alt="Avatar">
                <div class="header-actions" style="display: flex; gap: 15px; align-items: center;">
                    <button id="btn-lan-history" class="gold-link-btn">Historique des LANs</button>
                    <button id="logout-btn" class="danger-link-btn">Déconnexion</button>
                </div>
            </div>
        </header>

        <div id="view-voting-open" class="container wide-container" style="display: none;">

            <div class="two-column-layout">
                <!-- LEFT SIDEBAR -->
                <aside id="left-sidebar" class="animated-section">
                    <div id="active-users-sidebar" class="luxury-panel sidebar-module">
                        <h3 class="sidebar-title">Joueurs</h3>
                        <div id="users-list-container"></div>
                    </div>

                    <div id="admin-panel-open" class="luxury-panel sidebar-module"
                        style="display: none; border-color: var(--danger-color);">
                        <h3
                            style="margin: 0 0 15px 0; color: var(--danger-color); font-size: 1.1em; text-align: center;">
                            Mode Admin</h3>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <button id="toggle-voting-btn-open" class="gold-btn"
                                style="background: var(--accent-color); color: var(--dark-bg); border: none; padding: 12px; cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: bold; border-radius: 4px; width: 100%;">Clôturer
                                le Vote</button>

                            <label
                                style="font-family: 'Playfair Display', serif; font-size: 0.9em; color: var(--accent-color); margin-bottom: -10px;">Éditer
                                le vote de :</label>
                            <select id="voter-select-menu"
                                style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: var(--primary-text); font-family: 'Outfit'; border-radius: 2px;">
                                <option value="">-- Mon Vote --</option>
                            </select>
                        </div>
                    </div>
                </aside>

                <!-- CENTER FEED -->
                <main id="main-center-feed">

                    <section class="kpi-grid animated-section">
                        <div class="kpi-card luxury-panel">
                            <div class="kpi-card-title">Jeu Gagnant</div>
                            <img id="winner-image" src="" alt="Winner game image">
                            <div id="kpi-winner-value" class="kpi-card-value">--</div>
                        </div>
                        <div class="kpi-card luxury-panel">
                            <div class="kpi-card-title">Votants</div>
                            <div id="kpi-voters-value" class="kpi-card-value">0</div>
                        </div>
                        <div class="kpi-card luxury-panel">
                            <div class="kpi-card-title">Jeux Proposés</div>
                            <div id="kpi-games-value" class="kpi-card-value">0</div>
                        </div>
                    </section>

                    <section class="chart-wrapper luxury-panel animated-section" style="animation-delay: 0.2s;">
                        <h2>Top 8 des Jeux</h2>
                        <div id="chart-container"></div>
                    </section>

                    <div class="main-content animated-section" style="animation-delay: 0.4s;">
                        <div class="results-container luxury-panel">
                            <h2>Classement & Scores</h2>
                            <table class="results-table" id="results-table">
                                <thead>
                                    <tr>
                                        <th>Jeu</th>
                                        <th>Score</th>
                                    </tr>
                                </thead>
                                <tbody id="results-table-body">
                                </tbody>
                            </table>
                        </div>

                        <div class="form-container luxury-panel">
                            <h2>Mon Vote</h2>
                            <form id="vote-form">
                                <div class="priority-group" data-priority="p1">
                                    <h3>Priorité 1 <span>(5 pts)</span></h3>
                                    <div class="game-input-list"></div>
                                </div>
                                <div class="priority-group" data-priority="p2">
                                    <h3>Priorité 2 <span>(3 pts)</span></h3>
                                    <div class="game-input-list"></div>
                                    <button type="button" class="add-game-btn">+</button>
                                </div>
                                <div class="priority-group" data-priority="p3">
                                    <h3>Priorité 3 <span>(2 pts)</span></h3>
                                    <div class="game-input-list"></div>
                                    <button type="button" class="add-game-btn">+</button>
                                </div>
                                <div class="priority-group" data-priority="p_other">
                                    <h3>Autres <span>(1 pt)</span></h3>
                                    <div class="game-input-list"></div>
                                    <button type="button" class="add-game-btn">+</button>
                                </div>
                                <div class="form-actions">
                                    <button type="submit" id="submit-vote-btn">Soumettre mon Vote</button>
                                </div>
                            </form>
                        </div>
                    </div>

            </div> <!-- End Two Column Layout -->
        </div> <!-- End View Voting Open -->

        <!-- VIEW 2: USER WAITING (CLOSED) -->
        <div id="view-waiting-closed"
            style="display: none; position: relative; min-height: 70vh; flex-direction: column; align-items: center; justify-content: flex-start; padding-top: 50px;">

            <div class="waiting-content luxury-panel"
                style="position: relative; z-index: 10; text-align: center; padding: 40px; max-width: 600px; animation: etherealFadeInUp 1s ease forwards; margin-bottom: 40px;">
                <h2 style="font-size: 2.5em; margin-top: 0; margin-bottom: 20px;">Les votes sont fermés</h2>
                <div class="pulsing-indicator"
                    style="width: 50px; height: 2px; background: var(--accent-color); margin: 0 auto 30px auto; box-shadow: 0 0 10px var(--accent-color);">
                </div>
                <p style="font-size: 1.25em; margin: 0;">L'administrateur prépare la suite de la LAN...</p>
            </div>

            <div id="closed-results-display" class="results-container luxury-panel"
                style="width: 100%; max-width: 800px; animation: etherealFadeInUp 1.2s ease forwards;">
                <h2>Top Jeux à Télécharger</h2>
                <div id="closed-download-list" style="display: flex; flex-direction: column; gap: 15px;"></div>
            </div>
        </div>

        <!-- VIEW 3: ADMIN DASHBOARD (CLOSED) -->
        <div id="view-admin-dashboard" class="container" style="display: none; padding-top: 40px;">
            <div class="admin-dashboard-card luxury-panel"
                style="max-width: 800px; margin: 0 auto; padding: 50px; animation: etherealFadeInUp 0.8s ease forwards;">
                <h2
                    style="font-size: 2.2em; border-bottom: none; margin-bottom: 40px; text-shadow: 0 0 15px var(--accent-glow);">
                    Console d'Administration</h2>

                <div class="admin-controls-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div class="admin-control-item"
                        style="background: rgba(255,255,255,0.02); padding: 25px; border: 1px solid rgba(255,255,255,0.05); border-radius: 2px;">
                        <h3
                            style="margin-top: 0; font-size: 1.2em; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; color: var(--primary-text);">
                            Statut de la LAN</h3>
                        <p style="margin-bottom: 20px; font-size: 0.9em;">Les votes sont actuellement clos. Appuyez
                            ci-dessous pour relancer les votes.</p>
                        <button id="toggle-voting-btn-dashboard" class="gold-btn"
                            style="width: 100%; background: var(--accent-color); color: var(--dark-bg); border: none; padding: 15px; cursor: pointer; font-family: 'Outfit', sans-serif; font-weight: bold; font-size: 1.1em; letter-spacing: 1px; transition: all 0.3s; border-radius: 2px;">Ouvrir
                            le Vote</button>
                    </div>

                    <div class="admin-control-item"
                        style="background: rgba(255,255,255,0.02); padding: 25px; border: 1px solid rgba(255,255,255,0.05); border-radius: 2px;">
                        <h3
                            style="margin-top: 0; font-size: 1.2em; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; color: var(--primary-text);">
                            Configuration</h3>
                        <label
                            style="display: block; margin-bottom: 10px; font-family: 'Playfair Display', serif; font-size: 1.1em; color: var(--accent-color);">Top
                            Jeux à Télécharger :</label>
                        <input type="number" id="dashboard-top-games-count" value="10" min="1" max="50"
                            style="width: 100%; padding: 15px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: var(--primary-text); font-family: 'Outfit'; font-size: 1.2em; text-align: center; border-radius: 2px; margin-bottom: 20px;"
                            title="Nombre de jeux à afficher à la clôture">
                        <label
                            style="display: block; margin-bottom: 10px; font-family: 'Playfair Display', serif; font-size: 1.1em; color: var(--accent-color);">Nom
                            de la LAN :</label>
                        <input type="text" id="dashboard-lan-name" value="LAN Demain"
                            style="width: 100%; padding: 15px; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); color: var(--primary-text); font-family: 'Outfit'; font-size: 1.2em; text-align: center; border-radius: 2px;"
                            placeholder="Nom de l'événement">
                        <button id="save-config-btn"
                            style="width: 100%; margin-top: 15px; background: transparent; border: 1px solid var(--border-color); color: var(--primary-text); padding: 10px; cursor: pointer; font-family: 'Outfit'; transition: all 0.3s;">Sauvegarder
                            Configuration</button>
                    </div>

                    <div class="admin-control-item danger-zone"
                        style="grid-column: 1 / -1; background: rgba(158,54,54,0.05); padding: 25px; border: 1px solid rgba(158,54,54,0.2); border-radius: 2px; margin-top: 20px;">
                        <h3
                            style="margin-top: 0; font-size: 1.2em; text-align: left; border-bottom: 1px solid rgba(158,54,54,0.2); padding-bottom: 15px; margin-bottom: 20px; color: var(--danger-color);">
                            Zone Dangereuse</h3>
                        <p style="margin-bottom: 20px; font-size: 0.9em;">Attention: réinitialiser les votes supprime de
                            manière permanente toutes les données de vote actuelles de la base de données.</p>
                        <button id="reset-all-votes-btn-dashboard"
                            style="width: 100%; background: transparent; color: var(--danger-color); border: 1px solid var(--danger-color); padding: 15px; cursor: pointer; font-family: 'Outfit', sans-serif; font-size: 1.1em; letter-spacing: 1px; transition: all 0.3s; border-radius: 2px;"
                            onmouseover="this.style.background='rgba(158,54,54,0.1)'"
                            onmouseout="this.style.background='transparent'">Réinitialiser TOUS les votes</button>
                    </div>
                </div>

                <div id="admin-closed-results-display" class="results-container"
                    style="width: 100%; margin-top: 40px; padding-top: 40px; border-top: 1px solid var(--border-color);">
                    <h2>Top Jeux Actuels</h2>
                    <div id="admin-closed-download-list" style="display: flex; flex-direction: column; gap: 15px;">
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="correction-modal" class="modal-overlay">
        <div class="modal-content luxury-panel">
            <h3>Correction Automatique</h3>
            <p>Nous avons détecté des noms de jeux qui ressemblent à d'autres déjà votés. Voulez-vous les fusionner ?
            </p>
            <ul id="suggestions-list"></ul>
            <div class="modal-actions">
                <button id="modal-cancel">Annuler</button>
                <button id="modal-ignore">Ignorer & Sauvegarder tel quel</button>
                <button id="modal-accept">Accepter & Fusionner</button>
            </div>
        </div>
    </div>

    <div id="final-results-modal" class="modal-overlay"
        style="align-items: flex-start; padding-top: 10vh; overflow-y: auto;">
        <div class="modal-content luxury-panel" style="max-width: 800px; padding: 40px;">
            <h2 style="font-size: 2.5em; margin-top: 0;">Résultats Définitifs</h2>
            <p style="text-align: center; margin-bottom: 30px; font-size: 1.2em;">La liste des jeux à Télécharger pour
                la LAN !</p>
            <div id="download-list" style="display: flex; flex-direction: column; gap: 20px;"></div>
            <div class="modal-actions" style="margin-top: 40px; justify-content: center;">
                <button id="close-results-btn"
                    style="width: 100%; border-color: var(--accent-color); color: var(--accent-color);">Fermer</button>
            </div>
        </div>
    </div>

    <!-- LAN HISTORY MODAL -->
    <div id="history-modal" class="modal-overlay" style="display: none; z-index: 2000;">
        <div class="luxury-panel modal-content"
            style="max-width: 800px; width: 90%; max-height: 85vh; padding: 40px; display: flex; flex-direction: column;">
            <h2 style="font-size: 2em; margin-bottom: 10px;">Historique des LANs</h2>
            <p style="text-align: center; margin-bottom: 30px; font-style: italic;">Retrouvez les jeux qui ont marqué
                nos précédents événements.</p>

            <div id="history-list-container"
                style="flex: 1; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center; color: var(--secondary-text); font-style: italic;">Chargement de
                    l'historique...</div>
            </div>

            <button id="close-history-modal-btn" class="gold-btn"
                style="width: 100%; padding: 15px; font-size: 1.1em;">Fermer</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="config.js"></script>
    <script>
        const normalizeGameName = (name) => {
            if (typeof name !== 'string') return '';
            return name.trim().toLowerCase().replace(/\s+/g, ' ');
        };

        function levenshtein(s1, s2) { s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = []; for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i === 0) costs[j] = j; else if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) !== s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length]; }

        function checkTypos(newGames, currentVotes) {
            const suggestions = [];
            const masterGameList = new Set();
            Object.values(currentVotes).forEach(voteData => {
                if (voteData.votes) Object.values(voteData.votes).forEach(games => games.forEach(game => masterGameList.add(normalizeGameName(game))));
            });
            const masterArray = Array.from(masterGameList);
            newGames.forEach(newGame => {
                if (masterGameList.has(newGame)) return;
                for (const masterGame of masterArray) {
                    const distance = levenshtein(newGame, masterGame);
                    if (distance > 0 && distance <= 2) {
                        suggestions.push({ original: newGame, suggestion: masterGame });
                        return;
                    }
                }
            });
            return suggestions;
        }

        function calculateScores(votes) {
            const gameScores = {};
            const pointsMapping = { p1: 5, p2: 3, p3: 2, p_other: 1 };
            for (const userId in votes) {
                const voteData = votes[userId];
                if (voteData && voteData.votes) {
                    for (const priority in voteData.votes) {
                        voteData.votes[priority].forEach(game => {
                            const normalizedGame = normalizeGameName(game);
                            if (normalizedGame) {
                                gameScores[normalizedGame] = (gameScores[normalizedGame] || 0) + pointsMapping[priority];
                            }
                        });
                    }
                }
            }

            const finalScores = {};
            Object.keys(gameScores).forEach(name => {
                const capitalizedName = name.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                finalScores[capitalizedName] = gameScores[name];
            });

            return Object.entries(finalScores).map(([name, score]) => ({ name, score })).sort((a, b) => b.score - a.score);
        }

        function animateCounter(element, target) {
            if (element.animationFrameId) cancelAnimationFrame(element.animationFrameId);
            const startValue = parseInt(element.textContent) || 0;
            if (startValue === target) {
                element.textContent = target;
                return;
            }
            const duration = 1000;
            let startTime = null;
            function animationStep(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                const currentVal = progress < duration ? startValue + Math.floor(progress / duration * (target - startValue)) : target;
                element.textContent = currentVal;
                if (progress < duration) element.animationFrameId = requestAnimationFrame(animationStep);
            }
            element.animationFrameId = requestAnimationFrame(animationStep);
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        // --- INITIALISATION ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const googleProvider = new firebase.auth.GoogleAuthProvider();

        document.addEventListener('DOMContentLoaded', () => {
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');
            const googleLoginBtn = document.getElementById('google-login-btn');
            const loginBtnText = document.getElementById('login-btn-text');
            const loginSpinner = document.getElementById('login-spinner');
            const authErrorP = document.getElementById('auth-error');
            const logoutBtn = document.getElementById('logout-btn');
            const userNameSpan = document.getElementById('user-name');
            const userAvatarImg = document.getElementById('user-avatar');

            let votesRef = null;
            let settingsRef = null;
            let globalVotes = {};
            let globalSettings = { isVotingOpen: true, topGamesCount: 10 };
            let appInitialized = false;
            let isEditing = false;
            const imageCache = new Map();
            const DEFAULT_GAME_ICON = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23666'%3E%3Cpath d='M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-2.5 14H6.5v-1.5h11V18zm0-2.5H6.5v-1.5h11V15.5zm0-2.5H6.5v-1.5h11V13zm-5-3.25L10.25 8h1.5l2.25 1.75V8h1.5v6h-1.5v-1.75L13.25 14h-1.5L9.5 12.25V14H8V8h1.5v1.75z'/%3E%3C/svg%3E`;

            const voteForm = document.getElementById('vote-form');
            const voterSelectMenu = document.getElementById('voter-select-menu');
            const correctionModal = document.getElementById('correction-modal');

            auth.onAuthStateChanged(user => {
                if (user) {
                    authContainer.style.display = 'none';
                    appContainer.style.display = 'block';
                    userNameSpan.textContent = user.displayName || user.email;
                    userAvatarImg.src = user.photoURL || '';
                    if (votesRef) votesRef.off();
                    if (settingsRef) settingsRef.off();
                    initializeApp(user);
                } else {
                    authContainer.style.display = 'block';
                    appContainer.style.display = 'none';
                    if (votesRef) votesRef.off();
                    if (settingsRef) settingsRef.off();
                }
            });

            googleLoginBtn.addEventListener('click', () => {
                authErrorP.textContent = '';
                googleLoginBtn.disabled = true;
                loginBtnText.style.display = 'none';
                loginSpinner.style.display = 'block';

                auth.signInWithPopup(googleProvider)
                    .catch(error => {
                        authErrorP.textContent = error.message;
                    })
                    .finally(() => {
                        googleLoginBtn.disabled = false;
                        loginBtnText.style.display = 'inline-block';
                        loginSpinner.style.display = 'none';
                    });
            });

            logoutBtn.addEventListener('click', () => {
                const user = auth.currentUser;
                if (user) {
                    db.ref('/status/' + user.uid).remove();
                }
                auth.signOut();
            });

            async function getGameImage(gameName) {
                const normalizedName = gameName.toLowerCase().trim();
                if (imageCache.has(normalizedName)) {
                    return imageCache.get(normalizedName);
                }

                try {
                    const response = await fetch(`/api/get-game-image?name=${encodeURIComponent(normalizedName)}`);
                    if (response.ok) {
                        const data = await response.json();
                        imageCache.set(normalizedName, data.imageUrl);
                        return data.imageUrl;
                    } else {
                        const fallbackUrl = `https://placehold.co/600x400/222/FFF?text=${encodeURIComponent(gameName)}`;
                        imageCache.set(normalizedName, fallbackUrl);
                        return fallbackUrl;
                    }
                } catch (error) {
                    console.error("API Error:", error);
                }
                const fallbackUrl = `https://placehold.co/600x400/222/FFF?text=${encodeURIComponent(gameName)}`;
                imageCache.set(normalizedName, fallbackUrl);
                return fallbackUrl;
            }

            function renderActiveUsers(users) {
                const sidebar = document.getElementById('active-users-sidebar');
                const body = document.body;
                if (!sidebar) return;

                sidebar.innerHTML = '';
                const userCount = users ? Object.keys(users).length : 0;

                if (userCount > 0) {
                    sidebar.classList.add('visible');
                    body.classList.add('sidebar-visible');
                } else {
                    sidebar.classList.remove('visible');
                    body.classList.remove('sidebar-visible');
                }

                for (const uid in users) {
                    const user = users[uid];
                    const img = document.createElement('img');
                    img.src = user.avatar;
                    img.title = user.name;
                    img.className = 'user-avatar-icon';

                    const wrapper = document.createElement('div');
                    wrapper.className = 'user-avatar-container online';
                    wrapper.dataset.name = user.name;

                    if (globalVotes && globalVotes[uid] && Object.values(globalVotes[uid].votes || {}).some(arr => arr.length > 0)) {
                        wrapper.classList.add('avatar-connected-voted');
                    }
                    wrapper.appendChild(img);
                    sidebar.appendChild(wrapper);
                }

                // Add disconnected users who have voted
                if (globalVotes) {
                    for (const uid in globalVotes) {
                        if (!users || !users[uid]) {
                            const voteData = globalVotes[uid];
                            if (Object.values(voteData.votes || {}).some(arr => arr.length > 0)) {
                                const wrapper = document.createElement('div');
                                wrapper.className = 'user-avatar-container avatar-disconnected-voted';
                                wrapper.dataset.name = voteData.name + ' (Déconnecté)';

                                const img = document.createElement('img');
                                // Use a placeholder if they are disconnected and we don't naturally have their avatar
                                img.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(voteData.name)}&background=random`;
                                img.className = 'user-avatar-icon';

                                wrapper.appendChild(img);
                                sidebar.appendChild(wrapper);
                            }
                        }
                    }
                }
            }

            function initializeApp(user) {
                const isAdmin = user.uid === ADMIN_UID;
                window.currentUserIsAdmin = isAdmin;

                if (isAdmin) {
                    if (document.getElementById('admin-panel')) document.getElementById('admin-panel').style.display = 'block';
                    if (document.getElementById('admin-panel-open')) document.getElementById('admin-panel-open').style.display = 'block';
                }

                const userStatusRef = db.ref('/status/' + user.uid);
                const connectedRef = db.ref('.info/connected');

                connectedRef.on('value', (snap) => {
                    if (snap.val() === true) {
                        const userData = { name: user.displayName, avatar: user.photoURL };
                        userStatusRef.set(userData);
                        userStatusRef.onDisconnect().remove();
                    }
                });

                db.ref('/status').on('value', snapshot => renderActiveUsers(snapshot.val()));

                votesRef = db.ref('lan/votes');
                settingsRef = db.ref('lan/settings');

                settingsRef.on('value', (snapshot) => {
                    const newSettings = snapshot.val() || { isVotingOpen: true, topGamesCount: 10 };
                    globalSettings = newSettings;

                    const lanName = newSettings.lanName || "LAN Demain";
                    const mainTitle = document.getElementById('main-title');
                    if (mainTitle) mainTitle.textContent = lanName;

                    const dashboardInput = document.getElementById('dashboard-lan-name');
                    if (dashboardInput && document.activeElement !== dashboardInput) {
                        dashboardInput.value = lanName;
                    }

                    if (appInitialized && globalSettings.isVotingOpen === true && newSettings.isVotingOpen === false) {
                        showToast("Les votes sont terminés ! Voici les résultats...", "success");
                        showFinalResults();
                    }

                    updateVotingUIState();

                    if (isAdmin) {
                        const toggleBtns = document.querySelectorAll('#toggle-voting-btn, #toggle-voting-btn-open, #toggle-voting-btn-dashboard');
                        toggleBtns.forEach(btn => btn && (btn.textContent = globalSettings.isVotingOpen ? "Clôturer le Vote" : "Ouvrir le Vote"));
                        const countInputs = document.querySelectorAll('#top-games-count, #dashboard-top-games-count');
                        countInputs.forEach(input => input && (input.value = globalSettings.topGamesCount || 10));
                    }
                });

                votesRef.on('value', (snapshot) => {
                    globalVotes = snapshot.val() || {};
                    renderDashboard(globalVotes, user);

                    const selectedUserId = voterSelectMenu.value || user.uid;
                    if (!isEditing || selectedUserId !== user.uid) {
                        loadVoteIntoForm(selectedUserId, globalVotes, user);
                    }
                    appInitialized = true;
                });

                updateVotingUIState();
            }

            function updateVotingUIState() {
                const viewVotingOpen = document.getElementById('view-voting-open');
                const viewWaitingClosed = document.getElementById('view-waiting-closed');
                const viewAdminDashboard = document.getElementById('view-admin-dashboard');
                const adminPanelOpen = document.getElementById('admin-panel-open');
                const form = document.getElementById('vote-form');
                const message = document.getElementById('voting-closed-message');

                if (viewVotingOpen) viewVotingOpen.style.display = 'none';
                if (viewWaitingClosed) viewWaitingClosed.style.display = 'none';
                if (viewAdminDashboard) viewAdminDashboard.style.display = 'none';
                if (adminPanelOpen) adminPanelOpen.style.display = 'none';

                if (globalSettings.isVotingOpen) {
                    if (viewVotingOpen) viewVotingOpen.style.display = 'block';
                    if (form) form.style.display = 'flex';
                    if (message) message.style.display = 'none';
                    if (window.currentUserIsAdmin && adminPanelOpen) {
                        adminPanelOpen.style.display = 'block';
                    }
                } else {
                    if (form) form.style.display = 'none';
                    if (message) message.style.display = 'block';

                    if (window.currentUserIsAdmin) {
                        if (viewAdminDashboard) viewAdminDashboard.style.display = 'block';
                    } else {
                        if (viewWaitingClosed) viewWaitingClosed.style.display = 'flex';
                    }
                }
            }

            const handleToggleVoting = () => {
                const newIsOpen = !globalSettings.isVotingOpen;
                const countInput = document.getElementById('dashboard-top-games-count');
                const newCount = countInput ? (parseInt(countInput.value) || globalSettings.topGamesCount || 10) : 10;
                const lanNameInput = document.getElementById('dashboard-lan-name');
                const newLanName = lanNameInput ? lanNameInput.value.trim() : (globalSettings.lanName || "LAN Demain");

                // If we are CLOSING the votes, archive the results
                if (!newIsOpen && Object.keys(globalVotes).length > 0) {
                    const sortedGames = calculateScores(globalVotes);
                    const topGamesToSave = sortedGames.slice(0, newCount);
                    db.ref('lan/history').push({
                        date: Date.now(),
                        name: newLanName,
                        games: topGamesToSave
                    });
                }

                db.ref('lan/settings').set({
                    isVotingOpen: newIsOpen,
                    topGamesCount: newCount,
                    lanName: newLanName
                }).then(() => {
                    if (newIsOpen) {
                        db.ref('lan/votes').remove();
                        showToast("Nouveau vote démarré. Anciens votes effacés.", "success");
                    }
                }).catch(error => {
                    showToast("Erreur de permission. Vérifiez les règles Firebase.", "error");
                    console.error("Firebase Rule Error:", error);
                });
            };

            document.getElementById('toggle-voting-btn')?.addEventListener('click', handleToggleVoting);
            document.getElementById('toggle-voting-btn-open')?.addEventListener('click', handleToggleVoting);
            document.getElementById('toggle-voting-btn-dashboard')?.addEventListener('click', handleToggleVoting);

            document.getElementById('save-config-btn')?.addEventListener('click', () => {
                const countEl = document.getElementById('dashboard-top-games-count');
                const newCount = countEl ? (parseInt(countEl.value) || 10) : 10;
                const lanNameInput = document.getElementById('dashboard-lan-name');
                const newLanName = lanNameInput ? lanNameInput.value.trim() : (globalSettings.lanName || "LAN Demain");
                db.ref('lan/settings').set({
                    isVotingOpen: globalSettings.isVotingOpen,
                    topGamesCount: newCount,
                    lanName: newLanName
                }).then(() => showToast("Configuration sauvegardée", "success"))
                    .catch(e => showToast("Erreur: " + e.message, "error"));
            });

            document.getElementById('close-results-btn')?.addEventListener('click', () => {
                document.getElementById('final-results-modal').style.display = 'none';
            });

            document.getElementById('btn-lan-history')?.addEventListener('click', () => {
                document.getElementById('history-modal').style.display = 'flex';
                renderHistoryModal();
            });

            document.getElementById('close-history-modal-btn')?.addEventListener('click', () => {
                document.getElementById('history-modal').style.display = 'none';
            });

            function renderHistoryModal() {
                const container = document.getElementById('history-list-container');
                if (!container) return;

                container.innerHTML = '<div style="text-align: center; color: var(--secondary-text); font-style: italic;">Chargement de l\'historique...</div>';

                db.ref('lan/history').once('value').then(snapshot => {
                    const historyData = snapshot.val();
                    container.innerHTML = '';

                    if (!historyData) {
                        container.innerHTML = '<div style="text-align: center; color: var(--secondary-text); font-style: italic;">Aucun historique de LAN trouvé.</div>';
                        return;
                    }

                    // Map keys to objects and sort by newest first
                    const historyArray = Object.entries(historyData).map(([key, data]) => ({ key, ...data })).sort((a, b) => b.date - a.date);

                    historyArray.forEach(lanEvent => {
                        const eventDate = new Date(lanEvent.date).toLocaleDateString();
                        const card = document.createElement('div');
                        card.style.cssText = 'background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); padding: 25px; border-radius: 4px; border-left: 3px solid var(--accent-color); transition: background 0.3s;';

                        // Header (Clickable for accordion)
                        const header = document.createElement('div');
                        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none;';

                        const titleAndDate = document.createElement('div');
                        titleAndDate.innerHTML = `<h3 style="margin: 0; color: var(--accent-color); font-size: 1.4em; text-align: left;">${lanEvent.name}</h3><span style="color: var(--secondary-text); font-size: 0.9em;">${eventDate}</span>`;

                        const actionsRow = document.createElement('div');
                        actionsRow.style.cssText = 'display: flex; gap: 15px; align-items: center;';

                        const expandIcon = document.createElement('span');
                        expandIcon.innerHTML = '&#9660;'; // Down arrow
                        expandIcon.style.cssText = 'color: var(--secondary-text); transition: transform 0.3s;';

                        if (window.currentUserIsAdmin) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.textContent = 'Supprimer';
                            deleteBtn.style.cssText = 'background: transparent; border: 1px solid rgba(158, 54, 54, 0.5); color: var(--danger-color); padding: 4px 10px; border-radius: 2px; cursor: pointer; font-size: 0.8em; z-index: 10;';
                            deleteBtn.onclick = (e) => {
                                e.stopPropagation(); // Prevents accordion toggle
                                if (confirm("Supprimer cet historique définitivement ?")) {
                                    db.ref('lan/history/' + lanEvent.key).remove().then(() => {
                                        renderHistoryModal();
                                    });
                                }
                            };
                            actionsRow.appendChild(deleteBtn);
                        }

                        actionsRow.appendChild(expandIcon);
                        header.appendChild(titleAndDate);
                        header.appendChild(actionsRow);

                        // Content (Games List)
                        const gamesContainer = document.createElement('div');
                        gamesContainer.style.cssText = 'display: none; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;';

                        if (lanEvent.games && lanEvent.games.length > 0) {
                            let gamesHtml = '<ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px;">';
                            lanEvent.games.forEach((game, idx) => {
                                const crown = idx === 0 ? '👑' : '';
                                gamesHtml += `
                                    <li style="display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 2px;">
                                        <span style="color: var(--primary-text); font-weight: ${idx === 0 ? 'bold' : 'normal'};">#${idx + 1} ${game.name} ${crown}</span>
                                        <span style="color: var(--accent-color); font-size: 0.9em;">${game.score} pts</span>
                                    </li>
                                `;
                            });
                            gamesHtml += '</ul>';
                            gamesContainer.innerHTML = gamesHtml;
                        } else {
                            gamesContainer.innerHTML = '<p style="font-style: italic; color: var(--secondary-text); font-size: 0.9em; margin: 0;">Aucun jeu enregistré pour cet événement.</p>';
                        }

                        // Accordion Logic
                        header.addEventListener('click', () => {
                            const isExpanded = gamesContainer.style.display === 'block';
                            gamesContainer.style.display = isExpanded ? 'none' : 'block';
                            expandIcon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
                            card.style.background = isExpanded ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.05)';
                        });

                        card.appendChild(header);
                        card.appendChild(gamesContainer);
                        container.appendChild(card);
                    });
                }).catch(e => {
                    container.innerHTML = `<div style="text-align: center; color: var(--danger-color);">Erreur de chargement: ${e.message}</div>`;
                });
            }

            document.getElementById('reset-all-votes-btn')?.addEventListener('click', () => {
                const confirmation = prompt("Cette action est irréversible et supprimera TOUS les votes. Pour confirmer, tapez 'RESET'.");
                if (confirmation === 'RESET') {
                    db.ref('lan/votes').remove()
                        .then(() => showToast("Tous les votes ont été réinitialisés.", "success"))
                        .catch((err) => showToast("Erreur lors de la réinitialisation: " + err.message, "error"));
                } else if (confirmation !== null) {
                    showToast("Action annulée.");
                }
            });

            document.getElementById('reset-all-votes-btn-dashboard')?.addEventListener('click', () => {
                const confirmation = prompt("Cette action est irréversible et supprimera TOUS les votes. Pour confirmer, tapez 'RESET'.");
                if (confirmation === 'RESET') {
                    db.ref('lan/votes').remove()
                        .then(() => showToast("Tous les votes ont été réinitialisés.", "success"))
                        .catch((err) => showToast("Erreur lors de la réinitialisation: " + err.message, "error"));
                } else if (confirmation !== null) {
                    showToast("Action annulée.");
                }
            });

            if (voteForm) {
                voteForm.addEventListener('input', () => {
                    if (voterSelectMenu.value === '' || (auth.currentUser && voterSelectMenu.value === auth.currentUser.uid)) {
                        isEditing = true;
                    }
                });

                voteForm.addEventListener('click', (e) => {
                    if (e.target.classList.contains('add-game-btn')) {
                        const list = e.target.previousElementSibling;
                        createInput('', false, list);
                    }
                    if (e.target.classList.contains('remove-game-btn')) {
                        e.target.closest('.game-input-wrapper').remove();
                    }
                    const searchButton = e.target.closest('.steam-search-btn');
                    if (searchButton) {
                        handleSteamSearch(searchButton);
                    }
                });

                voteForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const user = auth.currentUser;
                    if (!user) return;
                    const userIdToSave = voterSelectMenu.value || user.uid;
                    const userNameToSave = (globalVotes[userIdToSave]) ? globalVotes[userIdToSave].name : user.displayName;
                    const playerVotes = { p1: [], p2: [], p3: [], p_other: [] };
                    const allNewGames = new Set();

                    document.querySelectorAll('.priority-group').forEach(group => {
                        const priority = group.dataset.priority;
                        group.querySelectorAll('.game-input-list input').forEach(input => {
                            const game = normalizeGameName(input.value);
                            if (game) {
                                playerVotes[priority].push(game);
                                allNewGames.add(game);
                            }
                        });
                    });

                    const suggestions = checkTypos(Array.from(allNewGames), globalVotes);
                    if (suggestions.length > 0) {
                        showCorrectionModal(suggestions, { userIdToSave, userNameToSave, playerVotes });
                    } else {
                        saveVote(userIdToSave, userNameToSave, playerVotes, user);
                    }
                });
            }

            if (voterSelectMenu) {
                voterSelectMenu.addEventListener('change', (e) => {
                    isEditing = false;
                    const user = auth.currentUser;
                    if (user) {
                        loadVoteIntoForm(e.target.value || user.uid, globalVotes, user);
                    }
                });
            }

            async function handleSteamSearch(searchButton) {
                const inputField = searchButton.closest('.game-input-wrapper').querySelector('input');
                const searchTerm = inputField.value.trim();
                const previewImg = document.getElementById('game-preview-image');
                const previewContainerMsg = document.querySelector('#game-preview-container span');

                if (searchTerm === '') return;

                searchButton.innerHTML = '...';
                searchButton.disabled = true;

                try {
                    const response = await fetch(`/api/get-game-image?name=${encodeURIComponent(searchTerm)}`);
                    if (response.ok) {
                        const data = await response.json();
                        inputField.value = data.name;

                        if (previewImg && data.imageUrl) {
                            previewImg.src = data.imageUrl;
                            previewImg.style.opacity = '1';
                            if (previewContainerMsg) previewContainerMsg.style.display = 'none';
                        }
                    } else {
                        showToast('Jeu non trouvé sur Steam.', 'error');
                        const fallbackUrl = `https://placehold.co/600x400/222/FFF?text=${encodeURIComponent(searchTerm)}`;
                        if (previewImg) {
                            previewImg.src = fallbackUrl;
                            previewImg.style.opacity = '1';
                            if (previewContainerMsg) previewContainerMsg.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error("Erreur Steam:", error);
                    showToast("Erreur de l'API Steam.", 'error');
                } finally {
                    searchButton.textContent = 'Vérifier';
                    searchButton.disabled = false;
                }
            }

            function saveVote(userId, userName, playerVotes, user) {
                db.ref(`lan/votes/${userId}`).set({ name: userName, votes: playerVotes })
                    .then(() => {
                        if (userId === user.uid) {
                            isEditing = false;
                        }
                        if (correctionModal && !correctionModal.style.display.includes('flex')) {
                            showToast(`Vote pour ${userName} enregistré !`, 'success');
                        }
                    })
                    .catch(error => {
                        console.error("Erreur:", error);
                        showToast(`Erreur : ${error.message}`, 'error');
                    });
            }

            function showCorrectionModal(suggestions, voteData) {
                const listElement = document.getElementById('suggestions-list');
                listElement.innerHTML = '';
                suggestions.forEach(sugg => {
                    const li = document.createElement('li');
                    li.innerHTML = `Remplacer votre saisie <em>${sugg.original}</em> par le jeu déjà existant <strong>${sugg.suggestion}</strong> ?`;
                    listElement.appendChild(li);
                });

                const newAcceptBtn = document.getElementById('modal-accept').cloneNode(true);
                document.getElementById('modal-accept').replaceWith(newAcceptBtn);
                const newIgnoreBtn = document.getElementById('modal-ignore').cloneNode(true);
                document.getElementById('modal-ignore').replaceWith(newIgnoreBtn);
                const newCancelBtn = document.getElementById('modal-cancel').cloneNode(true);
                document.getElementById('modal-cancel').replaceWith(newCancelBtn);

                const handler = () => { correctionModal.style.display = 'none'; };
                const acceptHandler = () => {
                    const correctedVotes = JSON.parse(JSON.stringify(voteData.playerVotes));
                    suggestions.forEach(sugg => {
                        for (const priority in correctedVotes) {
                            correctedVotes[priority] = correctedVotes[priority].map(game => normalizeGameName(game) === sugg.original ? sugg.suggestion : game);
                        }
                    });
                    saveVote(voteData.userIdToSave, voteData.userNameToSave, correctedVotes, auth.currentUser);
                    handler();
                };
                const ignoreHandler = () => {
                    saveVote(voteData.userIdToSave, voteData.userNameToSave, voteData.playerVotes, auth.currentUser);
                    handler();
                };

                newAcceptBtn.addEventListener('click', acceptHandler);
                newIgnoreBtn.addEventListener('click', ignoreHandler);
                newCancelBtn.addEventListener('click', handler);

                correctionModal.style.display = 'flex';
            }


            function createInput(value, isFirst, list) {
                const wrapper = document.createElement('div');
                wrapper.className = 'game-input-wrapper';

                const input = document.createElement('input');
                input.type = 'text';
                input.value = value;
                input.placeholder = 'Jeu...';
                if (list.closest('.priority-group')?.dataset.priority === 'p1') {
                    input.placeholder = 'Le jeu que vous voulez absolument...';
                }
                wrapper.appendChild(input);

                const searchButton = document.createElement('button');
                searchButton.type = 'button';
                searchButton.className = 'steam-search-btn';
                searchButton.title = 'Vérifier le nom sur Steam';
                searchButton.textContent = 'Vérifier';
                wrapper.appendChild(searchButton);

                if (list.closest('.priority-group')?.dataset.priority !== 'p1') {
                    const removeButton = document.createElement('button');
                    removeButton.type = 'button';
                    removeButton.className = 'remove-game-btn';
                    removeButton.textContent = '-';
                    if (isFirst) {
                        removeButton.style.visibility = 'hidden';
                    }
                    wrapper.appendChild(removeButton);
                }
                list.appendChild(wrapper);
            }

            function loadVoteIntoForm(userId, allVotes, currentUser) {
                const voteData = allVotes[userId];
                const playerVotes = voteData ? voteData.votes : {};
                const submitBtn = document.getElementById('submit-vote-btn');

                if (submitBtn) {
                    if (userId === currentUser.uid && voteData && Object.values(playerVotes).some(p => p.length > 0)) {
                        submitBtn.textContent = 'Mettre à jour mon Vote';
                    } else {
                        submitBtn.textContent = 'Soumettre mon Vote';
                    }
                }

                document.querySelectorAll('.priority-group').forEach(group => {
                    const priority = group.dataset.priority;
                    const games = playerVotes[priority] || [];
                    const list = group.querySelector('.game-input-list');
                    if (list) {
                        list.innerHTML = '';
                        if (games.length > 0) {
                            games.forEach((game, index) => createInput(game, index === 0, list));
                        } else {
                            createInput('', true, list);
                        }
                    }
                });
            }

            function renderKPIs(gamesData, votes) {
                const winnerName = gamesData.length > 0 ? gamesData[0].name : '--';
                const winnerValueEl = document.getElementById('kpi-winner-value');
                if (winnerValueEl) winnerValueEl.textContent = winnerName;
                const winnerImage = document.getElementById('winner-image');

                if (winnerImage) {
                    winnerImage.classList.remove('loaded');
                    winnerImage.src = '';
                    if (winnerName !== '--') {
                        getGameImage(winnerName).then(imageUrl => {
                            winnerImage.src = imageUrl;
                            if (imageUrl.startsWith('https')) {
                                winnerImage.classList.add('loaded');
                            }
                        });
                    }
                }

                const votersValueEl = document.getElementById('kpi-voters-value');
                if (votersValueEl) animateCounter(votersValueEl, Object.keys(votes).length);

                const gamesValueEl = document.getElementById('kpi-games-value');
                if (gamesValueEl) animateCounter(gamesValueEl, gamesData.length);
            }

            function renderTable(gamesData) {
                const tableBody = document.getElementById('results-table-body');
                if (!tableBody) return;

                tableBody.innerHTML = '';
                if (gamesData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center;">Aucun vote pour le moment...</td></tr>`;
                    return;
                }
                gamesData.forEach((game, index) => {
                    const row = document.createElement('tr');
                    const rank = index + 1;
                    if (rank === 1) row.classList.add('gold');
                    else if (rank === 2) row.classList.add('silver');
                    else if (rank === 3) row.classList.add('bronze');

                    const gameCell = document.createElement('td');
                    const scoreCell = document.createElement('td');

                    const gameIcon = document.createElement('img');
                    gameIcon.src = DEFAULT_GAME_ICON;
                    gameIcon.alt = 'Icone';
                    gameIcon.className = 'game-icon';

                    getGameImage(game.name).then(imageUrl => {
                        gameIcon.src = imageUrl;
                    });

                    gameCell.appendChild(gameIcon);
                    gameCell.append(`${rank}. ${game.name}`);
                    scoreCell.textContent = game.score;

                    row.appendChild(gameCell);
                    row.appendChild(scoreCell);
                    tableBody.appendChild(row);
                });
            }

            function renderChart(gamesData) {
                const chartContainer = document.getElementById('chart-container');
                if (!chartContainer) return;

                chartContainer.innerHTML = '';
                const topGames = gamesData.slice(0, 8);
                if (topGames.length === 0) return;

                const maxScore = topGames.length > 0 ? topGames[0].score : 0;

                topGames.forEach((game, index) => {
                    const barHeight = maxScore > 0 ? Math.max((game.score / maxScore) * 100, 15) : 0;

                    const barGroup = document.createElement('div');
                    barGroup.className = 'chart-bar-group';

                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = `${barHeight}%`;

                    const barLabel = document.createElement('div');
                    barLabel.className = 'bar-label';
                    const crown = '';
                    barLabel.textContent = `${game.score} ${crown}`;

                    const gameNameLabel = document.createElement('div');
                    gameNameLabel.className = 'chart-game-name';
                    gameNameLabel.textContent = game.name;

                    if (index === 0) barGroup.classList.add('gold');
                    else if (index === 1) barGroup.classList.add('silver');
                    else if (index === 2) barGroup.classList.add('bronze');

                    bar.appendChild(barLabel);
                    barGroup.appendChild(bar);
                    barGroup.appendChild(gameNameLabel);
                    chartContainer.appendChild(barGroup);
                });
            }

            function populateVoterMenu(votes, currentUser) {
                if (!voterSelectMenu) return;
                const currentSelection = voterSelectMenu.value;
                voterSelectMenu.innerHTML = '<option value="">-- Mon Vote --</option>';
                const sortedVoters = Object.entries(votes).sort((a, b) => a[1].name.localeCompare(b[1].name));
                sortedVoters.forEach(([uid, voteData]) => {
                    if (uid === currentUser.uid) return;
                    const option = document.createElement('option');
                    option.value = uid;
                    option.textContent = voteData.name;
                    voterSelectMenu.appendChild(option);
                });
                voterSelectMenu.value = currentSelection;
            }

            function renderDashboard(votes, user) {
                const sortedGames = calculateScores(votes);
                populateVoterMenu(votes, user);
                renderKPIs(sortedGames, votes);
                renderTable(sortedGames);
                renderChart(sortedGames);

                if (globalSettings && !globalSettings.isVotingOpen) {
                    showFinalResults(false);
                }
            }

            function showFinalResults(showModalDialog = true) {
                const sortedGames = calculateScores(globalVotes);
                const count = globalSettings.topGamesCount || 10;
                const topGames = sortedGames.slice(0, count);

                const listContainer = document.getElementById('download-list');
                const closedUserList = document.getElementById('closed-download-list');
                const closedAdminList = document.getElementById('admin-closed-download-list');
                const finalModal = document.getElementById('final-results-modal');

                const renderGamesToList = (container, gamesToRender) => {
                    if (!container) return;
                    container.innerHTML = '';
                    gamesToRender.forEach((game, index) => {
                        const item = document.createElement('div');
                        item.style.cssText = `display: flex; align-items: center; background: rgba(20,20,20,0.8); border: 1px solid var(--border-color); padding: 15px; border-radius: 4px; gap: 20px; opacity: 0; animation: etherealFadeInUp 0.5s forwards ${index * 0.1}s;`;

                        const img = document.createElement('img');
                        img.src = DEFAULT_GAME_ICON;
                        img.style.cssText = "width: 120px; height: 56px; object-fit: cover; border-radius: 2px; box-shadow: 0 2px 10px rgba(0,0,0,0.5);";
                        getGameImage(game.name).then(url => img.src = url);

                        const rank = document.createElement('div');
                        rank.style.cssText = "font-family: 'Playfair Display'; font-size: 2em; color: var(--accent-color); min-width: 40px;";
                        rank.textContent = `#${index + 1}`;

                        const details = document.createElement('div');
                        details.style.flex = "1";
                        const title = document.createElement('div');
                        title.style.cssText = "font-family: 'Playfair Display'; font-size: 1.3em; color: var(--primary-text); margin-bottom: 5px;";
                        title.textContent = game.name;
                        const scoreDesc = document.createElement('div');
                        scoreDesc.style.cssText = "font-size: 0.9em; color: var(--secondary-text);";
                        scoreDesc.textContent = `${game.score} points`;

                        details.appendChild(title);
                        details.appendChild(scoreDesc);

                        item.appendChild(rank);
                        item.appendChild(img);
                        item.appendChild(details);

                        container.appendChild(item);
                    });
                };

                renderGamesToList(listContainer, topGames);
                renderGamesToList(closedUserList, topGames);
                renderGamesToList(closedAdminList, topGames);

                if (showModalDialog && finalModal) {
                    finalModal.style.display = 'flex';
                }
            }

            async function renderMarquee() {
                const tracks = [
                    document.getElementById('waiting-marquee-1'),
                    document.getElementById('waiting-marquee-2'),
                    document.getElementById('waiting-marquee-3'),
                    document.getElementById('waiting-marquee-4')
                ];

                if (!tracks[0] || tracks[0].childElementCount > 0) return;

                const sortedGames = calculateScores(globalVotes);
                let gamesForMarquee = sortedGames.slice(0, 5).map(g => g.name);

                const topSteamGames = [
                    "Counter-Strike 2", "Dota 2", "PUBG: BATTLEGROUNDS",
                    "Apex Legends", "Helldivers 2", "Palworld", "Grand Theft Auto V",
                    "Team Fortress 2", "Rust", "Baldur's Gate 3", "Cyberpunk 2077",
                    "ELDEN RING", "War Thunder", "Left 4 Left 2", "Terraria",
                    "Stardew Valley", "Rainbow Six Siege", "ARK: Survival Evolved",
                    "The Witcher 3", "Path of Exile", "Rocket League", "Destiny 2",
                    "Garry's Mod", "Fallout 4", "Dead by Daylight", "Red Dead Redemption 2",
                    "Age of Empires II", "Phasmophobia", "Hollow Knight", "Lethal Company",
                    "Among Us", "Halo Infinite", "Borderlands 3"
                ];

                for (let game of topSteamGames) {
                    if (!gamesForMarquee.includes(game)) {
                        gamesForMarquee.push(game);
                    }
                }

                // Create a massive pool of cards
                gamesForMarquee = gamesForMarquee.sort(() => 0.5 - Math.random());

                const createCard = async (gameName) => {
                    const imgUrl = await getGameImage(gameName);
                    if (imgUrl === DEFAULT_GAME_ICON) return null;

                    const card = document.createElement('div');
                    card.className = 'marquee-card';
                    card.style.backgroundImage = `url(${imgUrl})`;
                    return card;
                };

                const cards = [];
                // Generate first batch rapidly
                for (const name of gamesForMarquee.slice(0, 20)) {
                    const c = await createCard(name);
                    if (c) cards.push(c);
                }

                if (cards.length === 0) return;

                // Distribute clones randomly across all 4 tracks to create the "Wall of Pictures"
                tracks.forEach((track, index) => {
                    if (!track) return;
                    // Shuffle the deck for each track so it looks chaotic and less structured
                    const trackCards = [...cards].sort(() => 0.5 - Math.random());
                    const allCards = [...trackCards, ...trackCards.map(c => c.cloneNode(true)), ...trackCards.map(c => c.cloneNode(true))];
                    allCards.forEach(c => track.appendChild(c.cloneNode(true)));
                });
            }

            renderMarquee();
        });

    </script>
</body>

</html>